# Maintainer: GhostKellz <ghostkellz@grimeditor.dev>
pkgname=thanos-ai
pkgver=0.95.0
pkgrel=1
pkgdesc="Universal AI provider abstraction layer"
arch=('x86_64' 'aarch64')
url="https://github.com/ghostkellz/thanos"
license=('MIT')
depends=('glibc' 'openssl' 'curl')
makedepends=('zig>=0.16.0' 'git')
optdepends=(
    'ollama: Local AI models (recommended)'
    'thanos-grim: Grim editor integration'
    'thanos-nvim: Neovim integration'
)
provides=('thanos' 'libthanos.so')
conflicts=('thanos')
source=("git+https://github.com/ghostkellz/thanos.git#tag=v${pkgver}")
sha256sums=('SKIP')

build() {
    cd "$srcdir/thanos"

    # Build CLI binary
    zig build -Doptimize=ReleaseFast

    # Build shared library
    zig build lib -Doptimize=ReleaseFast
}

check() {
    cd "$srcdir/thanos"

    # Run tests
    zig build test || echo "Tests skipped"
}

package() {
    cd "$srcdir/thanos"

    # Install CLI binary
    install -Dm755 "zig-out/bin/thanos" "$pkgdir/usr/bin/thanos"

    # Install shared library
    install -Dm755 "zig-out/lib/libthanos.so" "$pkgdir/usr/lib/libthanos.so"

    # Install headers for FFI (for plugin developers)
    install -dm755 "$pkgdir/usr/include/thanos"
    install -Dm644 "src/types.zig" "$pkgdir/usr/include/thanos/types.zig"
    install -Dm644 "src/root.zig" "$pkgdir/usr/include/thanos/root.zig"

    # Install default config
    install -Dm644 "config/default.zon" "$pkgdir/etc/thanos/config.zon"

    # Install documentation
    install -Dm644 "README.md" "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 "docs/providers.md" "$pkgdir/usr/share/doc/$pkgname/providers.md" 2>/dev/null || true
    install -Dm644 "LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Install shell completions if available
    if [ -f "completions/thanos.bash" ]; then
        install -Dm644 "completions/thanos.bash" "$pkgdir/usr/share/bash-completion/completions/thanos"
    fi

    if [ -f "completions/thanos.zsh" ]; then
        install -Dm644 "completions/thanos.zsh" "$pkgdir/usr/share/zsh/site-functions/_thanos"
    fi
}
